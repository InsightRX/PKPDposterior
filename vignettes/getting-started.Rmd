---
title: "Getting started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

We will start with defining a simple population PK model, for a fictitious drug.
We will define a one-compartment model, defined using standard PK parameters,
and with some inter-individual variability (IIV) and residual variability.

```{r r-load, echo=F}
library(PKPDposterior)
```

First, we will define the values of the population PK parameters:

```{r params}
pars <- list(
  CL = 5, 
  V1 = 50, 
  Q = 5, 
  V2 = 100
)
```

and the IIV (as standard deviation) and RUV:

```{r iiv}
iiv  <- list(
  CL = 0.3, 
  Q = 0.49, 
  V1 = 0.15, 
  V2 = 1.3
)
ruv  <- list(
  add = 1.6, 
  prop = 0.15
)
```

Now we can use `new_stan_model()` to define the model equations. Since this is
a simple linear PK model, we do not have to define the ODE system ourselves, 
but can instead use the analytic solution that is built into Torsten. The
only thing we need to define is how the parameters in Torsten related to any 
covariates that we want to use in the model. In this example, we'll implement
an allometric model for the PK parameters:

```{r define-model}
model <- new_stan_model(
  parameters = pars,
  parameter_definitions = list(
    "CL" = "CL * (WT[j]/70)^0.75",
    "Q"  = "Q  * (WT[j]/70)^0.75",
    "V1" = "V1 * WT[j]",
    "V2" = "V2 * WT[j]",
    "KA" = "0"
  ),
  covariate_definitions = list(
    "WT" = "real"    # WT in kg
  ),
  solver = "pmx_solve_twocpt",
  scale = "(V1 * mean(WT))"
)
```

The other elements that were specified above were:
- the covariate definitions: we only need to specify what the data type of the
respective covariates is. Here, we only have a continuous covariate, so we specify
it as `real`.
- the solver: the two-compartment analytic equation in Torsten is referenced as 
`pmx_solve_twocpt`. Please refer to the Torsten documentation for more information
about the available solvers.
- the scale: how the observed data relate to the modeled quantity (amounts in 
blood).

We can then write this model to file, and compile it using Stan:
```{r compile}
model_file <- write_stan_model(model)
mod <- load_model(model_file)
```